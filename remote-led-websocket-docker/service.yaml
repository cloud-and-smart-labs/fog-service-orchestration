---
tosca_definitions_version: tosca_simple_yaml_1_3

description: Service Template for deploying remote LED in swarm and Priviledged Container on Docker Engine

imports:
  - nodetypes/swarm/swarm.yaml
  - nodetypes/service_container/service_container.yaml
  - nodetypes/privileged_container/privileged_container.yaml

metadata:
  template_name: "fog service orchestration"
  template_author: "UoH"
  template_version: "1.0"

topology_template:
  inputs:
    host_ip:
      type: string
      
    managers:
      type: list
      default: []
    workers:
      type: list
      default: []

    privileged_nodes:
      type: list
      default: []

  node_templates:
    fog-workstation:
      type: tosca.nodes.Compute
      attributes:
        private_address: { get_input: host_ip }
        public_address: { get_input: host_ip }

    docker-swarm:
      type: fog.nodes.DockerSwarm
      properties:
        managers: { get_input: managers }
        workers: { get_input: workers }
      requirements:
        - host: fog-workstation

    python-websocket-server:
      type: fog.nodes.ServiceContainer
      properties:
        container_name: websocket_server
        image_name: suvambasak/pyimg:websocketledserver
        published_port: 7890
        target_port: 7890
        # replicas: 1
      requirements:
        - host: docker-swarm

    nginx-web-server:
      type: fog.nodes.ServiceContainer
      properties:
        container_name: nginx
        image_name: suvambasak/webpage:websocketled
        published_port: 80
        target_port: 80
        # replicas: 1
      requirements:
        - host: docker-swarm
        - dependency: python-websocket-server

    privileged-node-led-actuator:
      type: fog.nodes.PrivilegedContainer
      properties:
        container_name: led_actuator
        image_name: suvambasak/pyimg:websocketledactuator
        privileged_nodes: { get_input: privileged_nodes }
      requirements:
        - host: fog-workstation
        - dependency: python-websocket-server
...