---
tosca_definitions_version: tosca_simple_yaml_1_3

description: Service Template for remote LED with system services

imports:
  - relationshiptypes/token_transfer/token_transfer.yaml
  - nodetypes/swarm_leader/swarm_leader.yaml
  - nodetypes/swarm_worker/swarm_worker.yaml
  - nodetypes/docker_services/docker_services.yaml
  - nodetypes/system_service/system_service.yaml

topology_template:
  inputs:
    docker_service_name:
      type: string
      description: Docker stack name
    docker_service_url:
      type: string
      description: Docker stack compose file URL

    system_service_name:
      type: string
      description: Systemctl service name
    system_service_script_url:
      type: string
      description: Python script
    system_service_service_url:
      type: string
      description: .service file

  node_templates:
    # All fog nodes
    fog-node-1:
      type: tosca.nodes.Compute
      attributes:
        private_address: 192.168.0.166
        public_address: 192.168.0.166

    fog-node-2:
      type: tosca.nodes.Compute
      attributes:
        private_address: 192.168.0.165
        public_address: 192.168.0.165

    fog-node-3:
      type: tosca.nodes.Compute
      attributes:
        private_address: 192.168.0.103
        public_address: 192.168.0.103

    # Swarm leader node
    docker-swarm-leader:
      type: fog.docker.SwarmLeader
      requirements:
        - host: fog-node-1

    # Swarm worker nodes
    docker-swarm-worker-1:
      type: fog.docker.SwarmWorker
      requirements:
        - host: fog-node-2
        - leader: docker-swarm-leader

    docker-swarm-worker-2:
      type: fog.docker.SwarmWorker
      requirements:
        - host: fog-node-3
        - leader: docker-swarm-leader

    # Docker Service (SWARM)
    docker-service-1:
      type: fog.docker.Services
      properties:
        name: { get_input: docker_service_name }
        url: { get_input: docker_service_url }
      requirements:
        - host: docker-swarm-leader
        - dependency: docker-swarm-worker-1
        - dependency: docker-swarm-worker-2

    # System services
    system-service-1:
      type: fog.system.Service
      properties:
        name: { get_input: system_service_name }
        script_url: { get_input: system_service_script_url }
        service_url: { get_input: system_service_service_url }
        packages:
          - rpi.gpio
          - websockets
      requirements:
        - host: fog-node-1
        - dependency: docker-service-1

    system-service-2:
      type: fog.system.Service
      properties:
        name: { get_input: system_service_name }
        script_url: { get_input: system_service_script_url }
        service_url: { get_input: system_service_service_url }
        packages:
          - rpi.gpio
          - websockets
      requirements:
        - host: fog-node-2
        - dependency: docker-service-1

    system-service-3:
      type: fog.system.Service
      properties:
        name: { get_input: system_service_name }
        script_url: { get_input: system_service_script_url }
        service_url: { get_input: system_service_service_url }
        packages:
          - rpi.gpio
          - websockets
      requirements:
        - host: fog-node-3
        - dependency: docker-service-1

  outputs:
    output_worker_token_attribute:
      description: Swarm join token for worker nodes
      value: { get_attribute: [docker-swarm-leader, worker_token] }
    output_manager_token_attribute:
      description: Swarm join token for manager nodes
      value: { get_attribute: [docker-swarm-leader, manager_token] }
    advertised_address:
      description: Swarm join address
      value: { get_attribute: [docker-swarm-leader, advertise_addr] }
